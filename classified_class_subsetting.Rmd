---
title: "Subsetting taxonomic data"
output:
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Subsetting taxonomic data}
  %\VignetteEngine{knitr::rmarkdown}
  %\usepackage[utf8]{inputenc}
---

```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(knitr)
opts_chunk$set(dev='svg', fig.width = 7, fig.height = 7)
```


## Install metacoder for data and plotting

```{r, eval = FALSE}
devtools::install_github("grunwaldlab/metacoder") # do this before trying to knit
```

```{r}
library(metacoder)
library(taxa)
```


## Pepare data

```{r eval=FALSE}
file_path <- system.file("extdata", "unite_general_release.fasta", package = "metacoder")
sequences <- ape::read.FASTA(file_path)
unite_ex_data_3 <- extract_taxonomy(names(sequences),
                                    regex = "^(.*)\\|(.*)\\|(.*)\\|.*\\|(.*)$",
                                    key = c(name = "item_info", seq_id = "item_info",
                                            other_id = "item_info", "class_name"),
                                    database = "none")
```


## Creating the class from scratch

Normally, users would not create the class from scratch, since this is rather complex.
Instead, the class would be the output of functions like `metacoder::extract_taxonomy`.
`unite_ex_data_3` is an example of the current output format of `metacoder::extract_taxonomy`, but I would like to change its output to a `classified` object.

```{r}
data <- classified(taxon_id = unite_ex_data_3$taxa$taxon_id,
                   parent_id = unite_ex_data_3$taxa$parent_id,
                   item_taxon_id = unite_ex_data_3$items$taxon_id,
                   taxon_data = data.frame(name =  unite_ex_data_3$taxa$name,
                                           rank = unite_ex_data_3$taxa$rank),
                   item_data = data.frame(seq_id = unite_ex_data_3$items$seq_id))
```


## Acessing taxon data

Note how the `item_count` column is calculated each time it is needed. 
This is because the number of items per taxon can change when taxa are subsetted.

```{r}
head(taxon_data(data))
```


## Acessing item data

```{r}
head(item_data(data))
```


## Subsetting and plotting

I already made a `plot` method for `classified` in `metacoder` that calls `metacoder::plot_taxonomy`.
I also added some non-standard argument evaluation for the subsetting and plotting methods to save users some typing.
Columns in `classified_object$taxon_data` can be refereed to by name alone.

```{r}
plot(data, 
     vertex_size = item_count,
     vertex_color = item_count,
     vertex_label = name)
```

Note how this: 

```{r}
plot(data[name == "Ascomycota", ],
     vertex_size = item_count,
     vertex_color = item_count,
     vertex_label = name)
```

... is the same as this:

```{r}
data_subset <- data[data$taxon_data$name == "Ascomycota", ]
plot(data_subset,
     vertex_size = taxon_data(data_subset)$item_count,
     vertex_color = taxon_data(data_subset)$item_count,
     vertex_label = data_subset$taxon_data$name)
```


The `[[` currently corresponds to a more restrictive type of subsetting, in which the parents and children of taxa are not automatically preserved.

```{r}
plot(data[[item_count > 5]],
     vertex_size = item_count,
     vertex_color = item_count,
     vertex_label = name)
```

```{r}
plot(data[[item_count < 200]],
     vertex_size = item_count,
     vertex_color = item_count,
     vertex_label = name,
     layout = "fruchterman-reingold")
```

However, it is still not working right as you might expect. 
I think this is because, when a child taxon is eliminated, its items are not transferred to the parent taxon.
This is why some taxa in the above two plots have `0` items.
Their children all together had > 5 items, but each child had < 5 items. 
I think the solution is to transfer the items of eliminated children to their non-eliminated parents, but I need to look into this more.
